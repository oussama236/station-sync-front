<app-filters-prelevements
  (filtresStarted)="loadingSpinner = true"
  (filtresAppliques)="handleResultatsFiltres($event)">
</app-filters-prelevements>

<button
  nz-button
  class="show-hide-btn"
  [nzType]="'primary'"
  (click)="toggleForm()"
  [ngStyle]="
    showForm
      ? { width: '45px', height: '45px', padding: '0', display: 'flex', justifyContent: 'center', alignItems: 'center', fontSize: '18px', fontWeight: 'bold' }
      : { padding: '10px 24px', height: '45px', fontSize: '16px' }
  ">
  <span *ngIf="!showForm">+ Ajouter prélèvement</span>
  <span *ngIf="showForm">−</span>
</button>

<div style="display:flex;justify-content:center;align-items:flex-start;gap:15px;margin-top:20px;">
  <div *ngIf="showForm" style="display:flex;flex-wrap:wrap;gap:45px;align-items:center;">
    <label style="display:flex;flex-direction:column;">
      Date d'opération:
      <input nz-input type="date" [(ngModel)]="newPrelevement.dateOperation" name="dateOperation" required />
    </label>

    <label style="display:flex;flex-direction:column;">
      Numéro de compte:
      <input nz-input type="text" [(ngModel)]="newPrelevement.numeroCompte" name="numeroCompte" required [readOnly]="true" />
    </label>

    <label style="display:flex;flex-direction:column;">
      Montant:
      <input nz-input type="number" [(ngModel)]="newPrelevement.montant" name="montant" required />
    </label>

    <div style="margin-top:23px;">
      <button nz-button nzType="primary" (click)="openSimulationModalForAdd()" style="height:35px;">
        Valider
      </button>
    </div>
  </div>
</div>

<div class="prelevements-table-holder" style="margin-top:1px;margin-bottom:1px;">
  <nz-table
    [nzData]="prelevements"
    [nzPaginationPosition]="'top'"
    [nzScroll]="{ y: '300px' }"
    nzSize="middle"
    [nzLoading]="loadingSpinner"
    [nzNoResult]="'Aucun Prélèvement'">

    <thead>
      <tr>
        <th nzWidth="180px">Date Opération</th>
        <th nzWidth="180px">Numéro de Compte</th>
        <th nzWidth="150px">Montant</th>
        <th nzWidth="150px">Factures associées</th>
        <th nzWidth="160px">Actions</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let p of prelevements">
        <!-- Date -->
        <td>
          <ng-container *ngIf="editId === p.idPrelevement; else viewDate">
            <input nz-input type="date" [(ngModel)]="edited!.dateOperation" />
          </ng-container>
          <ng-template #viewDate>{{ p.dateOperation | date: 'd MMMM y':'':'fr' }}</ng-template>
        </td>

        <!-- Numero compte (read-only) -->
        <td>{{ p.numeroCompte }}</td>

        <!-- Montant -->
        <td>
          <ng-container *ngIf="editId === p.idPrelevement; else viewMontant">
            <input nz-input type="number" [(ngModel)]="edited!.montant" />
          </ng-container>
          <ng-template #viewMontant>{{ p.montant | number: '1.3-3' }} DT</ng-template>
        </td>

        <!-- Eye to view shells -->
        <td class="center-eye">
          <button
            nz-button
            nzType="link"
            [disabled]="!p.shells || p.shells.length === 0"
            [ngClass]="{'eye-button': p.shells?.length > 0, 'eye-disabled': !p.shells || p.shells.length === 0}"
            (click)="p.shells?.length > 0 && ouvrirModalPrelevements(p.idPrelevement)">
            <i nz-icon nzType="eye" nzTheme="outline"></i>
          </button>
        </td>

        <!-- Actions -->
        <td>
          <div style="display:flex;gap:8px;justify-content:center;">
            <ng-container *ngIf="editId === p.idPrelevement; else viewButtons">
              <button nz-button nzType="primary" nzSize="small" (click)="onValidateEdit(p)" style="width:40px;" nzTooltip="Valider">
                <i nz-icon nzType="check" style="font-size:18px;"></i>
              </button>
              <button nz-button nzType="default" nzSize="small" (click)="onCancelEdit()" style="width:40px;" nzTooltip="Annuler">
                <i nz-icon nzType="close" style="font-size:18px;color:red;"></i>
              </button>
            </ng-container>

            <ng-template #viewButtons>
              <button nz-button nzType="default" nzSize="small" (click)="onModify(p)" style="width:40px;" nzTooltip="Modifier">
                <i nz-icon nzType="edit" style="font-size:18px;"></i>
              </button>
              <button nz-button nzType="default" nzDanger nzSize="small" (click)="onDelete(p)" style="width:40px;" nzTooltip="Supprimer">
                <i nz-icon nzType="delete" style="font-size:18px;color:#cc0000;"></i>
              </button>
            </ng-template>
          </div>
        </td>
      </tr>
    </tbody>
  </nz-table>
</div>
